<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Porcupine Wake Word Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .status.idle {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        .status.listening {
            background-color: #c8e6c9;
            color: #388e3c;
        }
        .status.detected {
            background-color: #fff9c4;
            color: #f57f17;
        }
        .status.error {
            background-color: #ffcdd2;
            color: #c62828;
        }
        button {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button.start {
            background-color: #4caf50;
            color: white;
        }
        button.start:hover {
            background-color: #45a049;
        }
        button.stop {
            background-color: #f44336;
            color: white;
        }
        button.stop:hover {
            background-color: #da190b;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .info {
            margin: 20px 0;
            padding: 15px;
            background-color: #f5f5f5;
            border-left: 4px solid #2196f3;
            border-radius: 4px;
        }
        .log {
            margin-top: 20px;
            padding: 15px;
            background-color: #263238;
            color: #aed581;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        .log-entry {
            margin: 5px 0;
        }
        .log-entry.wake {
            color: #ffeb3b;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Porcupine Wake Word Detection Test</h1>

        <div class="info">
            <strong>Note:</strong> This demo uses Porcupine's Web SDK with the built-in wake word.
            Say <strong>"Bumblebee"</strong> to trigger the detection!
        </div>

        <div id="status" class="status idle">
            Status: Idle - Click Start to begin
        </div>

        <button id="startBtn" class="start">Start Listening</button>
        <button id="stopBtn" class="stop" disabled>Stop Listening</button>

        <div class="log" id="log">
            <div class="log-entry">Waiting to start...</div>
        </div>
    </div>

    <!-- Load local IIFE bundles -->
    <script src="/lib/web-voice-processor.js"></script>
    <script src="/lib/index.js"></script>

    <script>
        (async function() {
            let porcupineManager = null;
            const statusDiv = document.getElementById('status');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const logDiv = document.getElementById('log');

            // Your AccessKey from Picovoice Console
            const ACCESS_KEY = '5UYg8RavZ9gkgSt0ES6kXA6DTX3Ugayqm8qw/htwvgCgRCf67oW1QA==';

            // Built-in keyword - Bumblebee
            const KEYWORDS = ['Bumblebee'];

            function updateStatus(message, type = 'idle') {
                statusDiv.textContent = message;
                statusDiv.className = `status ${type}`;
            }

            function addLog(message, isWake = false) {
                const entry = document.createElement('div');
                entry.className = isWake ? 'log-entry wake' : 'log-entry';
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logDiv.appendChild(entry);
                logDiv.scrollTop = logDiv.scrollHeight;
            }

            async function startPorcupine() {
                try {
                    addLog('Initializing Porcupine...');
                    updateStatus('Initializing...', 'idle');

                    // Detection callback
                    function detectionCallback(keywordIndex) {
                        const detectedKeyword = KEYWORDS[keywordIndex];
                        addLog(`ðŸŽ¯ WAKE WORD DETECTED: ${detectedKeyword}`, true);
                        updateStatus(`Wake word detected: ${detectedKeyword}!`, 'detected');

                        // Reset status after 2 seconds
                        setTimeout(() => {
                            if (porcupineManager) {
                                updateStatus('Listening for wake words...', 'listening');
                            }
                        }, 2000);
                    }

                    // Create Porcupine instance using the global PorcupineWeb object
                    addLog('Creating Porcupine worker...');

                    // Model configuration - specify where to find the model file
                    const modelConfig = {
                        publicPath: '/lib/porcupine_params.pv',
                        forceWrite: true
                    };

                    porcupineManager = await window.PorcupineWeb.PorcupineWorker.create(
                        ACCESS_KEY,
                        KEYWORDS,
                        detectionCallback,
                        modelConfig
                    );

                    addLog('âœ“ Porcupine worker created');
                    addLog('Requesting microphone access...');

                    // Subscribe Porcupine to WebVoiceProcessor to start capturing audio
                    await window.WebVoiceProcessor.WebVoiceProcessor.subscribe(porcupineManager);

                    addLog('âœ“ Porcupine started successfully');
                    addLog(`Listening for: ${KEYWORDS.join(', ')}`);
                    updateStatus('Listening for wake words...', 'listening');

                    startBtn.disabled = true;
                    stopBtn.disabled = false;

                } catch (error) {
                    console.error('Error starting Porcupine:', error);
                    addLog(`âŒ Error: ${error.message}`);
                    updateStatus(`Error: ${error.message}`, 'error');
                }
            }

            async function stopPorcupine() {
                if (porcupineManager) {
                    // Unsubscribe from WebVoiceProcessor
                    await window.WebVoiceProcessor.WebVoiceProcessor.unsubscribe(porcupineManager);

                    // Release Porcupine resources
                    await porcupineManager.release();
                    porcupineManager = null;
                }

                addLog('âœ“ Porcupine stopped');
                updateStatus('Status: Idle - Click Start to begin', 'idle');

                startBtn.disabled = false;
                stopBtn.disabled = true;
            }

            startBtn.addEventListener('click', startPorcupine);
            stopBtn.addEventListener('click', stopPorcupine);

            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                if (porcupineManager) {
                    porcupineManager.release();
                }
            });

            addLog('Ready! Click "Start Listening" to begin.');
        })();
    </script>
</body>
</html>
